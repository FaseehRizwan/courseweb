<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Course Detail | Student - Aurelius</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<style>
  body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}
  .sidebar-link{display:flex;align-items:center;gap:.75rem;padding:.5rem 1rem;border-radius:.375rem;font-size:.95rem;font-weight:500;color:#d1d5db;transition:.15s;}
  .sidebar-link:hover{background:#111827;color:#fff;}
  .lecture-item.active{background:#e3f2fd;border-left-color:#c09a59;}
  .lecture-item.active h4{color:#c09a59;}
  /* student mobile sidebar overlay (shared) */
  #student-mobile-menu { display:none; position:fixed; inset:0; z-index:60; }
  #student-mobile-menu .backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.5); }
  #student-mobile-menu .panel { position:absolute; left:0; top:0; bottom:0; width:78%; max-width:320px; background:#0f172a; color:#d1d5db; overflow:auto; padding:18px; }
  @media (max-width: 768px) { #student-mobile-menu.show { display:block; } }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <aside class="w-64 bg-gray-900 text-gray-200 hidden md:flex flex-col">
    <div class="h-16 flex items-center px-6 border-b border-gray-800">
      <a href="/" class="flex items-center space-x-2 text-white font-bold tracking-wider"><i data-feather="shield"></i><span>AURELIUS</span></a>
    </div>
    <nav class="flex-1 overflow-y-auto py-6 space-y-1">
      <a href="/student/dashboard" class="sidebar-link"><i data-feather="layout" class="w-4"></i><span>Dashboard</span></a>
      <a href="/student/profile" class="sidebar-link"><i data-feather="user" class="w-4"></i><span>Profile</span></a>
      <a href="/student/courses" class="sidebar-link"><i data-feather="book-open" class="w-4"></i><span>Courses</span></a>
      <a href="/student/notes" class="sidebar-link"><i data-feather="file-text" class="w-4"></i><span>Notes</span></a>
    </nav>
    <form method="post" action="/logout" class="p-4"><button class="w-full bg-[#c09a59] text-white py-2 rounded">Logout</button></form>
  </aside>

  <div class="flex-1 flex flex-col">
    <header class="h-16 bg-white shadow flex items-center justify-between px-6">
      <div class="flex items-center gap-3">
        <button id="student-menu-button" class="md:hidden text-gray-700 p-2 rounded hover:bg-gray-100" title="Open menu"><i data-feather="menu" class="w-5 h-5"></i></button>
        <h1 id="course-title-header" class="text-2xl font-bold">Loading Course...</h1>
      </div>
      <a href="/student/courses" class="text-sm text-gray-600 hover:text-gray-900">Back to Courses</a>
    </header>

    <!-- Student mobile menu -->
    <div id="student-mobile-menu" aria-hidden="true">
      <div class="backdrop" id="student-mobile-backdrop"></div>
      <nav class="panel">
        <div class="mb-6 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <span class="font-bold text-white">AURELIUS</span>
          </div>
          <button id="student-mobile-close" class="text-gray-300 hover:text-white"><i data-feather="x" class="w-5 h-5"></i></button>
        </div>
        <ul class="space-y-2 text-sm">
          <li><a href="/student/dashboard" class="block px-3 py-2 rounded hover:bg-gray-800 text-gray-100">Dashboard</a></li>
          <li><a href="/student/profile" class="block px-3 py-2 rounded hover:bg-gray-800 text-gray-100">Profile</a></li>
          <li><a href="/student/courses" class="block px-3 py-2 rounded hover:bg-gray-800 text-gray-100">Courses</a></li>
          <li><a href="/student/notes" class="block px-3 py-2 rounded hover:bg-gray-800 text-gray-100">Notes</a></li>
          <li><a href="/student/blogs" class="block px-3 py-2 rounded hover:bg-gray-800 text-gray-100">Blogs</a></li>
        </ul>
      </nav>
    </div>

    <main class="flex-1 p-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
          <div class="bg-black rounded-lg overflow-hidden aspect-video">
            <video id="lecture-video" controls class="w-full h-full" poster="https://placehold.co/1920x1080/000000/FFFFFF?text=Select+a+Lecture"></video>
          </div>
          <div class="mt-6 bg-white p-5 rounded shadow">
            <h2 id="lecture-title" class="text-2xl font-bold">Select a lecture to begin</h2>
            <p id="lecture-description" class="mt-3 text-gray-600">The video and description for the selected lecture will appear here.</p>
          </div>
          <div id="supporting-videos-wrapper" class="mt-6 bg-white p-5 rounded shadow hidden">
            <h3 class="text-xl font-bold mb-3">Supporting Videos</h3>
            <ul id="supporting-videos" class="space-y-2 text-sm"></ul>
          </div>
          <div class="mt-6 bg-white p-5 rounded shadow">
            <h3 class="text-xl font-bold">Resources</h3>
            <div id="lecture-resources" class="mt-3 text-sm text-gray-600">
              <p class="text-gray-500">Resources for the selected lecture will be listed here.</p>
            </div>
          </div>
        </div>
        <aside class="lg:col-span-1">
          <div class="bg-white p-5 rounded shadow sticky top-20">
            <h3 class="text-xl font-bold mb-4">Course Content</h3>
            <div id="playlist-container" class="space-y-2 max-h-[70vh] overflow-y-auto"></div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <script>feather.replace();</script>
  <script>
    (function(){
      const btn = document.getElementById('student-menu-button');
      const menu = document.getElementById('student-mobile-menu');
      const backdrop = document.getElementById('student-mobile-backdrop');
      const closeBtn = document.getElementById('student-mobile-close');
      function show(){ menu.classList.add('show'); if(window.feather) feather.replace(); document.body.style.overflow='hidden'; }
      function hide(){ menu.classList.remove('show'); document.body.style.overflow=''; }
      if(btn && menu) btn.addEventListener('click', e=>{ e.preventDefault(); show(); });
      if(backdrop) backdrop.addEventListener('click', hide);
      if(closeBtn) closeBtn.addEventListener('click', hide);
      try{ const panel = menu.querySelector('.panel'); if(panel) panel.querySelectorAll('a').forEach(a=>a.addEventListener('click', ()=>setTimeout(hide,50))); }catch(e){}
      document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') hide(); });
    })();
  </script>
  <script>
    const videoPlayer = document.getElementById('lecture-video');
    const lectureTitle = document.getElementById('lecture-title');
    const lectureDescription = document.getElementById('lecture-description');
    const lectureResources = document.getElementById('lecture-resources');
    const playlistContainer = document.getElementById('playlist-container');
    const supWrap = document.getElementById('supporting-videos-wrapper');
    const supList = document.getElementById('supporting-videos');

    document.addEventListener('DOMContentLoaded', ()=>{
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      const type = params.get('type'); // 'auth' for authorized
      if(!id){ lectureTitle.textContent='Invalid course id'; return; }
      if(type==='auth'){
        fetch('/api/student/auth-courses/'+id)
          .then(r=>r.json())
          .then(course=>{
            if(!course || course.error){ lectureTitle.textContent='Course Not Found'; return; }
            document.getElementById('course-title-header').textContent = course.title;
            document.title = course.title + ' | Student - Aurelius';
            (course.lectures||[]).forEach((lec,i)=>{
              const div=document.createElement('div');
              div.className='lecture-item p-4 border-l-4 border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors';
              div.innerHTML=`<h4 class="font-bold text-lg">${i+1}. ${lec.title}</h4><span class="text-sm text-gray-500">${lec.duration||''}</span>`;
              div.addEventListener('click',()=>updatePlayer(lec,div));
              playlistContainer.appendChild(div);
            });
            if(course.lectures && course.lectures.length){
              updatePlayer(course.lectures[0], playlistContainer.firstChild);
            }
          })
          .catch(()=> lectureTitle.textContent='Load error');
        return;
      }
      // Public course fallback
      fetch('/api/courses/public').then(r=>r.json()).then(courses=>{
        const course = courses.find(c=>String(c.id)===String(id));
        if(!course){ lectureTitle.textContent='Course Not Found'; return; }
        document.getElementById('course-title-header').textContent = course.title;
        document.title = course.title + ' | Student - Aurelius';
        (course.lectures||[]).forEach((lec,i)=>{
          const div=document.createElement('div');
          div.className='lecture-item p-4 border-l-4 border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors';
          div.innerHTML=`<h4 class="font-bold text-lg">${i+1}. ${lec.title}</h4><span class="text-sm text-gray-500">${lec.duration||''}</span>`;
          div.addEventListener('click',()=>updatePlayer(lec,div));
          playlistContainer.appendChild(div);
        });
        if(course.lectures && course.lectures.length){
          updatePlayer(course.lectures[0], playlistContainer.firstChild);
        }
      }).catch(()=>{ lectureTitle.textContent='Load error'; });
    });

    function updatePlayer(lecture, activeEl){
      const main = lecture.mainVideo || (lecture.videos && lecture.videos[0]) || null;
      const supporting = lecture.supportingVideos || (lecture.videos ? lecture.videos.slice(1) : []);
      if(main){ videoPlayer.src = main.url; videoPlayer.poster=''; }
      else { videoPlayer.removeAttribute('src'); videoPlayer.poster='https://placehold.co/1920x1080/000/FFF?text=No+Video'; }
      lectureTitle.textContent = lecture.title;
      lectureDescription.innerHTML = lecture.description || '';
      // Supporting
      supList.innerHTML='';
      if(supporting && supporting.length){
        supWrap.classList.remove('hidden');
        supporting.forEach(v=>{
          const li=document.createElement('li');
          li.innerHTML=`<button class="w-full text-left bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded flex justify-between">
            <span>${v.name||'Video'}</span><span class="text-xs text-gray-500">Play</span></button>`;
          li.querySelector('button').addEventListener('click',()=>{ videoPlayer.src=v.url; videoPlayer.play(); });
          supList.appendChild(li);
        });
      } else supWrap.classList.add('hidden');
      // Resources
      lectureResources.innerHTML='';
      const res = lecture.resources||[];
      if(res.length){
        const ul=document.createElement('ul');
        ul.className='list-disc list-inside space-y-2';
        res.forEach(r=>{
          ul.innerHTML += `<li><a class="text-blue-600 hover:underline" target="_blank" href="${r.url}">${r.name||'Resource'} ${r.type? '('+r.type+')':''}</a></li>`;
        });
        lectureResources.appendChild(ul);
      } else {
        lectureResources.innerHTML='<p class="text-gray-500">No resources.</p>';
      }
      document.querySelectorAll('.lecture-item').forEach(el=>el.classList.remove('active'));
      activeEl.classList.add('active');
    }
  </script>
</body>
</html>
